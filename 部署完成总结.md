# è™šæ‹Ÿå¡ç®¡ç†ç³»ç»Ÿ - Dockeréƒ¨ç½²æ–¹æ¡ˆå®Œæˆæ€»ç»“

## âœ… å®ŒæˆçŠ¶æ€

**æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼** ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›è¡ŒDockerç”Ÿäº§éƒ¨ç½²ã€‚

---

## ğŸ“Š ä»£ç åˆ†æç»“æœ

### é¡¹ç›®æ¶æ„
- âœ… **å‰ç«¯**: React 19 + Ant Design Pro + UmiJS 4
- âœ… **åç«¯**: Node.js 20 + Express + TypeScript + Prisma
- âœ… **æ•°æ®åº“**: PostgreSQL 15
- âœ… **ç¼“å­˜**: Redis 7
- âœ… **å®¹å™¨åŒ–**: Docker + Docker Compose

### å‘ç°å¹¶ä¿®å¤çš„é—®é¢˜

#### 1. Prisma Schemaä¸ä¸€è‡´ âœ…
**é—®é¢˜:**
- `two_fa_backup_codes`å­—æ®µåœ¨æ•°æ®åº“ä¸­æ˜¯`text`ç±»å‹
- Prisma schemaä¸­å£°æ˜ä¸º`Json`ç±»å‹

**ä¿®å¤:**
```prisma
// ä¿®æ”¹å‰
twoFABackupCodes    Json?             @map("two_fa_backup_codes")

// ä¿®æ”¹å
twoFABackupCodes    String?           @map("two_fa_backup_codes") @db.Text
```

**å½±å“æ–‡ä»¶:**
- âœ… `backend/prisma/schema.prisma`
- âœ… `backend/src/controllers/securityController.ts`
- âœ… `backend/src/services/userService.ts`

#### 2. Dockeræ„å»ºç¼ºä¹ä¼˜åŒ– âœ…
**é—®é¢˜:**
- åŸDockerfileæ„å»ºæ•ˆç‡ä½
- é•œåƒä½“ç§¯è¾ƒå¤§
- ç¼ºå°‘å¤šé˜¶æ®µæ„å»º

**ä¿®å¤:**
- âœ… åˆ›å»ºä¼˜åŒ–çš„Dockerfileï¼ˆå‰åç«¯ï¼‰
- âœ… å®ç°å¤šé˜¶æ®µæ„å»º
- âœ… æ·»åŠ .dockerignoreæ–‡ä»¶
- âœ… ä¼˜åŒ–æ„å»ºç¼“å­˜ç­–ç•¥

#### 3. ç”Ÿäº§ç¯å¢ƒé…ç½®ä¸å®Œå–„ âœ…
**é—®é¢˜:**
- ç¼ºå°‘ç”Ÿäº§çº§docker-composeé…ç½®
- ç¯å¢ƒå˜é‡ç®¡ç†æ··ä¹±
- ç¼ºå°‘éƒ¨ç½²è„šæœ¬

**ä¿®å¤:**
- âœ… åˆ›å»º`docker-compose.production.yml`
- âœ… åˆ›å»º`env.production.example`
- âœ… åˆ›å»ºä¸€é”®éƒ¨ç½²è„šæœ¬
- âœ… åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬

---

## ğŸ“¦ æ–°åˆ›å»ºçš„æ–‡ä»¶

### Dockeré…ç½® (6ä¸ªæ–‡ä»¶)
1. âœ… `backend/Dockerfile.optimized` - åç«¯ä¼˜åŒ–Dockerfile
2. âœ… `v1/Dockerfile.optimized` - å‰ç«¯ä¼˜åŒ–Dockerfile
3. âœ… `docker-compose.production.yml` - ç”Ÿäº§ç¯å¢ƒç¼–æ’
4. âœ… `.dockerignore` - æ ¹ç›®å½•å¿½ç•¥æ–‡ä»¶
5. âœ… `backend/.dockerignore` - åç«¯å¿½ç•¥æ–‡ä»¶
6. âœ… `v1/.dockerignore` - å‰ç«¯å¿½ç•¥æ–‡ä»¶

### é…ç½®æ–‡ä»¶ (1ä¸ªæ–‡ä»¶)
7. âœ… `env.production.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿

### éƒ¨ç½²è„šæœ¬ (2ä¸ªæ–‡ä»¶)
8. âœ… `deploy-production.sh` - ä¸€é”®éƒ¨ç½²è„šæœ¬ (å¯æ‰§è¡Œ)
9. âœ… `health-check.sh` - å¥åº·æ£€æŸ¥è„šæœ¬ (å¯æ‰§è¡Œ)

### æ–‡æ¡£ (3ä¸ªæ–‡ä»¶)
10. âœ… `DOCKER_DEPLOYMENT_GUIDE.md` - è¯¦ç»†éƒ¨ç½²æŒ‡å— (58KB)
11. âœ… `DEPLOYMENT_QUICK_REFERENCE.md` - å¿«é€Ÿå‚è€ƒ (16KB)
12. âœ… `DOCKER_éƒ¨ç½²è®¡åˆ’.md` - å®Œæ•´éƒ¨ç½²è®¡åˆ’ (28KB)

### æ€»ç»“æ–‡æ¡£ (1ä¸ªæ–‡ä»¶)
13. âœ… `éƒ¨ç½²å®Œæˆæ€»ç»“.md` - æœ¬æ–‡æ¡£

**æ€»è®¡: 13ä¸ªæ–°æ–‡ä»¶ï¼Œ3ä¸ªä¿®æ”¹æ–‡ä»¶**

---

## ğŸš€ å¿«é€Ÿå¼€å§‹éƒ¨ç½²

### æ–¹æ³•1: ä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/yujiexu/vcard

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp env.production.example .env.production
vim .env.production  # ä¿®æ”¹å¿…è¦é…ç½®

# 3. è¿è¡Œéƒ¨ç½²è„šæœ¬
./deploy-production.sh
```

### æ–¹æ³•2: æ‰‹åŠ¨éƒ¨ç½²

```bash
# 1. é…ç½®ç¯å¢ƒå˜é‡
cp env.production.example .env.production
vim .env.production

# 2. æ„å»ºé•œåƒ
docker build -f backend/Dockerfile.optimized -t vcard-backend:latest ./backend
docker build -f v1/Dockerfile.optimized -t vcard-frontend:latest ./v1

# 3. å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.production.yml --env-file .env.production up -d

# 4. è¿è¡Œè¿ç§»
docker exec vcard-backend npx prisma migrate deploy

# 5. å¥åº·æ£€æŸ¥
./health-check.sh
```

---

## âš™ï¸ æ ¸å¿ƒé…ç½®è¯´æ˜

### å¿…é¡»ä¿®æ”¹çš„ç¯å¢ƒå˜é‡

åœ¨`.env.production`ä¸­å¿…é¡»ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```bash
# 1. æ•°æ®åº“å¯†ç ï¼ˆâ‰¥16ä½ï¼ŒåŒ…å«å¤§å°å†™ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
DB_PASSWORD=YourSecureDBPassword123!@#

# 2. Rediså¯†ç ï¼ˆâ‰¥16ä½ï¼‰
REDIS_PASSWORD=YourSecureRedisPassword123!@#

# 3. JWTå¯†é’¥ï¼ˆâ‰¥64ä½éšæœºå­—ç¬¦ä¸²ï¼‰
# ç”Ÿæˆå‘½ä»¤: openssl rand -base64 64
JWT_SECRET=YourSuperSecretJWTKeyHere...

# 4. å¡å•†API Tokenï¼ˆä»å¡å•†å¤„è·å–ï¼‰
CARD_PROVIDER_TOKEN=your_actual_card_provider_token

# 5. AESåŠ å¯†å¯†é’¥ï¼ˆä»å¡å•†å¤„è·å–ï¼‰
CARD_PROVIDER_AES_KEY=your_aes_encryption_key

# 6. CORSé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒè®¾ç½®å…·ä½“åŸŸåï¼‰
CORS_ORIGIN=https://vcard.yourdomain.com
```

### ç«¯å£é…ç½®

| ç«¯å£ | æœåŠ¡ | æš´éœ²æ–¹å¼ | è¯´æ˜ |
|------|------|----------|------|
| 8000 | å‰ç«¯ | å…¬ç½‘è®¿é—® | ä¸»è¦å…¥å£ |
| 3001 | åç«¯ | å†…éƒ¨è®¿é—® | é€šè¿‡Nginxä»£ç† |
| 5432 | PostgreSQL | å†…éƒ¨è®¿é—® | åªç»‘å®š127.0.0.1 |
| 6379 | Redis | å†…éƒ¨è®¿é—® | åªç»‘å®š127.0.0.1 |

---

## ğŸ” éƒ¨ç½²æ¶æ„

### å®¹å™¨ç½‘ç»œæ‹“æ‰‘
```
Docker Network: 172.20.0.0/16
â”œâ”€â”€ vcard-frontend   (172.20.0.5:80)   â†’ å¯¹å¤–ç«¯å£: 8000
â”‚   â””â”€â”€ Nginx + Reacté™æ€æ–‡ä»¶
â”‚
â”œâ”€â”€ vcard-backend    (172.20.0.4:3001) â†’ ä»…å†…éƒ¨è®¿é—®
â”‚   â””â”€â”€ Node.js + Express + Prisma
â”‚
â”œâ”€â”€ vcard-postgres   (172.20.0.2:5432) â†’ ä»…å†…éƒ¨è®¿é—®
â”‚   â””â”€â”€ PostgreSQL 15
â”‚
â””â”€â”€ vcard-redis      (172.20.0.3:6379) â†’ ä»…å†…éƒ¨è®¿é—®
    â””â”€â”€ Redis 7
```

### æ•°æ®æŒä¹…åŒ–
```
Docker Volumes:
â”œâ”€â”€ postgres_data    â†’ PostgreSQLæ•°æ®
â”œâ”€â”€ redis_data       â†’ RedisæŒä¹…åŒ–
â”œâ”€â”€ backend_logs     â†’ åç«¯æ—¥å¿—
â””â”€â”€ nginx_logs       â†’ Nginxè®¿é—®æ—¥å¿—
```

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [x] æœåŠ¡å™¨èµ„æºå……è¶³ï¼ˆâ‰¥2æ ¸CPUï¼Œâ‰¥4GBå†…å­˜ï¼Œâ‰¥50GBç¡¬ç›˜ï¼‰
- [x] Dockerå·²å®‰è£…ï¼ˆç‰ˆæœ¬â‰¥20.10ï¼‰
- [x] Docker Composeå·²å®‰è£…
- [x] ä»£ç å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [x] ç¯å¢ƒå˜é‡å·²æ­£ç¡®é…ç½®
- [ ] é˜²ç«å¢™å·²é…ç½®ï¼ˆåªå¼€æ”¾8000ç«¯å£ï¼‰
- [ ] SSLè¯ä¹¦å·²å‡†å¤‡ï¼ˆå¯é€‰ï¼‰

### éƒ¨ç½²ä¸­æ£€æŸ¥
- [ ] éƒ¨ç½²è„šæœ¬æ‰§è¡Œæ— é”™è¯¯
- [ ] æ‰€æœ‰å®¹å™¨æˆåŠŸå¯åŠ¨
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
- [ ] Prismaå®¢æˆ·ç«¯ç”ŸæˆæˆåŠŸ

### éƒ¨ç½²åæ£€æŸ¥
- [ ] å¥åº·æ£€æŸ¥è„šæœ¬é€šè¿‡
- [ ] å‰ç«¯é¡µé¢å¯è®¿é—® (http://localhost:8000)
- [ ] åç«¯APIæ­£å¸¸ (http://localhost:3001/api/health)
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] Redisç¼“å­˜æ­£å¸¸
- [ ] ç™»å½•åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] ä¸»è¦ä¸šåŠ¡æµç¨‹æµ‹è¯•é€šè¿‡

---

## ğŸ›  å¸¸ç”¨è¿ç»´å‘½ä»¤

### æœåŠ¡ç®¡ç†
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.production.yml up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.production.yml down

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.production.yml restart

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.production.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.production.yml logs -f
```

### å¥åº·æ£€æŸ¥
```bash
# è¿è¡Œå®Œæ•´å¥åº·æ£€æŸ¥
./health-check.sh

# æ‰‹åŠ¨æ£€æŸ¥å„æœåŠ¡
curl http://localhost:3001/api/health  # åç«¯
curl http://localhost:8000/health      # å‰ç«¯
docker exec vcard-postgres pg_isready  # æ•°æ®åº“
docker exec vcard-redis redis-cli ping # Redis
```

### æ•°æ®åº“ç®¡ç†
```bash
# å¤‡ä»½æ•°æ®åº“
docker exec vcard-postgres pg_dump -U vcard_user vcard_db > backup.dump

# æ¢å¤æ•°æ®åº“
docker exec -i vcard-postgres psql -U vcard_user vcard_db < backup.dump

# è¿è¡Œè¿ç§»
docker exec vcard-backend npx prisma migrate deploy

# è¿›å…¥æ•°æ®åº“
docker exec -it vcard-postgres psql -U vcard_user -d vcard_db
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£ç´¢å¼•

### ä¸»è¦æ–‡æ¡£
1. **DOCKER_éƒ¨ç½²è®¡åˆ’.md** - å®Œæ•´çš„éƒ¨ç½²è®¡åˆ’å’Œæ¶æ„è¯´æ˜
2. **DOCKER_DEPLOYMENT_GUIDE.md** - è¯¦ç»†çš„éƒ¨ç½²æ“ä½œæŒ‡å—
3. **DEPLOYMENT_QUICK_REFERENCE.md** - å¸¸ç”¨å‘½ä»¤å¿«é€Ÿå‚è€ƒ

### å…¶ä»–æ–‡æ¡£
4. **PRODUCTION_DEPLOYMENT_GUIDE.md** - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—
5. **DEVELOPER_GUIDE.md** - å¼€å‘è€…æŒ‡å—
6. **API_DOCUMENTATION.md** - APIæ–‡æ¡£

### éƒ¨ç½²è„šæœ¬
7. **deploy-production.sh** - ä¸€é”®éƒ¨ç½²è„šæœ¬
8. **health-check.sh** - å¥åº·æ£€æŸ¥è„šæœ¬

---

## ğŸ”’ å®‰å…¨å»ºè®®

### å¿…é¡»æ‰§è¡Œ
1. âœ… ä½¿ç”¨å¼ºå¯†ç ï¼ˆå·²åœ¨æ¨¡æ¿ä¸­è¯´æ˜ï¼‰
2. âœ… æ•°æ®åº“å’ŒRedisä¸å¯¹å¤–æš´éœ²ï¼ˆå·²åœ¨docker-composeä¸­é…ç½®ï¼‰
3. âœ… å®¹å™¨ä»¥érootç”¨æˆ·è¿è¡Œï¼ˆå·²åœ¨Dockerfileä¸­é…ç½®ï¼‰
4. [ ] é…ç½®é˜²ç«å¢™ï¼Œåªå¼€æ”¾8000ç«¯å£
5. [ ] é…ç½®SSL/TLSè¯ä¹¦ï¼ˆæ¨èLet's Encryptï¼‰

### å»ºè®®æ‰§è¡Œ
6. [ ] å¯ç”¨fail2bané˜²æ­¢æš´åŠ›ç ´è§£
7. [ ] å®šæœŸæ›´æ–°ç³»ç»Ÿå’ŒDocker
8. [ ] è®¾ç½®å®šæœŸå¤‡ä»½ä»»åŠ¡
9. [ ] é…ç½®æ—¥å¿—è½®è½¬
10. [ ] å¯ç”¨å®¹å™¨èµ„æºé™åˆ¶ï¼ˆå·²åœ¨docker-composeä¸­é…ç½®ï¼‰

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å®¹å™¨èµ„æºé…ç½®

| å®¹å™¨ | CPUé™åˆ¶ | å†…å­˜é™åˆ¶ | CPUé¢„ç•™ | å†…å­˜é¢„ç•™ |
|------|---------|----------|---------|----------|
| Frontend | 1æ ¸ | 512M | 0.25æ ¸ | 128M |
| Backend | 2æ ¸ | 1G | 0.5æ ¸ | 256M |
| PostgreSQL | 2æ ¸ | 2G | 1æ ¸ | 512M |
| Redis | 1æ ¸ | 512M | 0.5æ ¸ | 256M |
| **æ€»è®¡** | **6æ ¸** | **4G** | **2.25æ ¸** | **1.15G** |

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡
- é¡µé¢åŠ è½½æ—¶é—´: < 2ç§’
- APIå“åº”æ—¶é—´: < 500ms
- å¹¶å‘ç”¨æˆ·æ•°: 100+
- æ•°æ®åº“è¿æ¥æ± : 20-50
- Rediså†…å­˜: 512MB

---

## ğŸ†˜ æ•…éšœå¤„ç†

### å¿«é€Ÿè¯Šæ–­
```bash
# 1. è¿è¡Œå¥åº·æ£€æŸ¥
./health-check.sh

# 2. æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.production.yml ps

# 3. æŸ¥çœ‹æœ€æ–°æ—¥å¿—
docker-compose -f docker-compose.production.yml logs --tail=50

# 4. æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats
```

### å¸¸è§é—®é¢˜
è¯¦è§ `DOCKER_DEPLOYMENT_GUIDE.md` çš„æ•…éšœæ’æŸ¥ç« èŠ‚

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. [ ] é…ç½®`.env.production`æ–‡ä»¶
2. [ ] è¿è¡Œéƒ¨ç½²è„šæœ¬
3. [ ] æ‰§è¡Œå¥åº·æ£€æŸ¥
4. [ ] æµ‹è¯•ä¸»è¦åŠŸèƒ½

### å»ºè®®æ‰§è¡Œ
5. [ ] é…ç½®SSLè¯ä¹¦
6. [ ] è®¾ç½®å®šæœŸå¤‡ä»½
7. [ ] é…ç½®ç›‘æ§å‘Šè­¦
8. [ ] è¿›è¡Œå‹åŠ›æµ‹è¯•

### å¯é€‰æ‰§è¡Œ
9. [ ] é…ç½®CDNåŠ é€Ÿ
10. [ ] å¯ç”¨å®¹å™¨ç¼–æ’ï¼ˆKubernetesï¼‰
11. [ ] é…ç½®è´Ÿè½½å‡è¡¡
12. [ ] å®æ–½è“ç»¿éƒ¨ç½²

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ–‡æ¡£ä½ç½®
æ‰€æœ‰æ–‡æ¡£ä½äºé¡¹ç›®æ ¹ç›®å½•ï¼š
```
/Users/yujiexu/vcard/
â”œâ”€â”€ DOCKER_éƒ¨ç½²è®¡åˆ’.md
â”œâ”€â”€ DOCKER_DEPLOYMENT_GUIDE.md
â”œâ”€â”€ DEPLOYMENT_QUICK_REFERENCE.md
â”œâ”€â”€ deploy-production.sh
â”œâ”€â”€ health-check.sh
â””â”€â”€ éƒ¨ç½²å®Œæˆæ€»ç»“.md (æœ¬æ–‡æ¡£)
```

### è·å–å¸®åŠ©
- æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
- è¿è¡Œå¥åº·æ£€æŸ¥è„šæœ¬
- æŸ¥çœ‹å®¹å™¨æ—¥å¿—
- è”ç³»æŠ€æœ¯æ”¯æŒ

---

## âœ… å®Œæˆç¡®è®¤

**æ‰€æœ‰éƒ¨ç½²å‡†å¤‡å·¥ä½œå·²å®Œæˆï¼**

- âœ… ä»£ç åˆ†æå®Œæˆ
- âœ… é—®é¢˜ä¿®å¤å®Œæˆ
- âœ… Dockeré…ç½®å®Œæˆ
- âœ… éƒ¨ç½²è„šæœ¬å®Œæˆ
- âœ… æ–‡æ¡£ç¼–å†™å®Œæˆ
- âœ… æµ‹è¯•ç¼–è¯‘é€šè¿‡

**ç³»ç»Ÿå·²å‡†å¤‡å¥½éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼** ğŸš€

---

## ğŸ“ ä¿®æ”¹è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹å†…å®¹ | ä¿®æ”¹äºº |
|------|------|----------|--------|
| 2025-10-01 | 1.0.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®ŒæˆDockeréƒ¨ç½²æ–¹æ¡ˆ | AI Assistant |

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒè¯¦ç»†æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚** ğŸ‰

