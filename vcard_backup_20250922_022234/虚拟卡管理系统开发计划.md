# 虚拟卡管理系统开发计划

## 项目概述

基于现有的 Ant Design Pro 前端模板（v1），开发一个对接卡商API的虚拟卡管理系统。系统包含虚拟卡管理和用户管理两大核心模块，支持三级用户权限体系。

## 技术栈分析

### 前端技术栈（已有）
- **框架**: React 19.1.0 + UmiJS 4.x
- **UI组件**: Ant Design 5.26.4 + ProComponents 2.8.9
- **样式**: antd-style 3.7.0
- **状态管理**: 内置 UmiJS 状态管理
- **类型检查**: TypeScript 5.6.3
- **构建工具**: UmiJS Max
- **代码规范**: Biome + Husky

### 后端技术栈（待搭建）
- **框架**: Node.js + Express.js / Koa.js
- **数据库**: PostgreSQL + Redis（缓存）
- **ORM**: Prisma / TypeORM
- **认证**: JWT + bcrypt
- **API文档**: Swagger/OpenAPI
- **日志**: Winston
- **进程管理**: PM2
- **容器化**: Docker

## 功能需求分析

### 1. 用户管理模块

#### 用户等级体系
- **超级管理员（Super Admin）**: 唯一，可管理所有用户和系统设置
- **管理员（Admin）**: 可管理归属于自己的普通用户
- **普通用户（User）**: 只能管理自己的虚拟卡

#### 用户管理功能
- 用户注册/邀请
- 用户信息管理（增删改查）
- 用户状态管理（启用/禁用）
- 权限分配和管理
- 用户归属关系管理

### 2. 虚拟卡管理模块

#### 核心功能
- **开卡**: 创建新的虚拟卡
- **删卡（释放）**: 释放虚拟卡资源
- **充值**: 向虚拟卡充值
- **提现**: 从虚拟卡提现
- **冻结**: 冻结虚拟卡
- **解冻（激活）**: 解冻虚拟卡

#### 卡片信息管理
- 卡片详情查看
- 卡片状态监控
- 交易记录查询（授权/结算）
- 余额管理
- 邮箱绑定

### 3. 卡商API对接

#### API安全机制
- IP白名单验证
- Token认证
- AES数据加密（CBC模式，PKCS7填充）
- Base64编码

#### 对接接口
- 创建虚拟卡 (`/openapi/card/hk/multi_issue`)
- 卡片充值 (`/openapi/card/hk/recharge`)
- 卡片提现 (`/openapi/card/withdraw`)
- 卡片释放 (`/openapi/card/hk/release`)
- 卡片详情 (`/openapi/card/hk/info`)
- 卡片冻结 (`/openapi/card/freeze`)
- 卡片激活 (`/openapi/card/activate`)
- 用户余额 (`/openapi/user/hk/get_bal`)
- 交易记录 (`/openapi/card/hk/get_auth`, `/openapi/card/hk/get_settle`)

## 数据库设计

### 核心表结构

#### 用户表 (users)
```sql
- id: 主键
- username: 用户名
- email: 邮箱
- password_hash: 密码哈希
- role: 用户角色 (super_admin, admin, user)
- parent_id: 上级用户ID（用于admin-user关系）
- status: 用户状态 (active, inactive, suspended)
- balance: 账户余额
- credit_limit: 信用额度
- currency: 默认币种 (USD, EUR, GBP等)
- created_at: 创建时间
- updated_at: 更新时间
```

#### 虚拟卡表 (virtual_cards)
```sql
- id: 主键
- user_id: 所属用户ID
- card_id: 卡商返回的卡片ID
- card_no: 卡号
- cvv: CVV码
- exp_date: 过期时间
- balance: 余额
- currency: 币种
- status: 卡片状态
- cardholder_name: 开卡人姓名
- cardholder_username: 开卡人用户名
- created_by: 创建者用户ID
- remark: 备注
- created_at: 创建时间
- updated_at: 更新时间
```

#### 交易记录表 (transactions)
```sql
- id: 主键
- card_id: 虚拟卡ID
- txn_id: 交易ID
- txn_type: 交易类型
- amount: 交易金额
- currency: 币种
- status: 交易状态
- created_at: 交易时间
```

## 开发阶段规划

### 第一阶段：后端基础架构搭建（1-2周）

#### 1.1 项目初始化
- [ ] 创建后端项目结构
- [ ] 配置开发环境（ESLint, Prettier, TypeScript）
- [ ] 设置数据库连接
- [ ] 配置环境变量管理

#### 1.2 基础中间件
- [ ] 身份认证中间件（JWT）
- [ ] 权限验证中间件
- [ ] 请求日志中间件
- [ ] 错误处理中间件
- [ ] CORS配置

#### 1.3 数据库设计实现
- [ ] 设计并创建数据库表结构
- [ ] 设置数据库迁移脚本
- [ ] 创建种子数据（初始超级管理员）

### 第二阶段：用户管理系统（1-2周）

#### 2.1 用户认证
- [ ] 用户注册功能
- [ ] 用户登录功能
- [ ] JWT Token生成和验证
- [ ] 密码重置功能

#### 2.2 用户管理API
- [ ] 用户CRUD操作
- [ ] 用户角色管理
- [ ] 用户状态管理
- [ ] 用户关系管理（admin-user）

#### 2.3 权限系统
- [ ] 基于角色的访问控制（RBAC）
- [ ] 接口权限验证
- [ ] 数据权限隔离

### 第三阶段：卡商API对接（2-3周）

#### 3.1 API客户端封装
- [ ] AES加密/解密工具
- [ ] HTTP客户端封装
- [ ] 错误处理和重试机制
- [ ] API响应数据验证

#### 3.2 虚拟卡操作API
- [ ] 开卡接口实现
- [ ] 充值接口实现
- [ ] 提现接口实现
- [ ] 释放接口实现
- [ ] 冻结/激活接口实现
- [ ] 卡片详情查询接口

#### 3.3 交易记录同步
- [ ] 授权记录同步
- [ ] 结算记录同步
- [ ] 交易状态更新
- [ ] 余额同步机制

### 第四阶段：前端页面开发（2-3周）

#### 4.1 用户管理页面
- [ ] 用户列表页面
  - [ ] 显示用户名、邮箱、角色等基本信息
  - [ ] 显示账户余额、信用额度、可用金额
  - [ ] 显示卡片数量和总消费
  - [ ] 支持按用户名、邮箱搜索
  - [ ] 支持按角色、状态筛选
  - [ ] 支持按余额范围筛选
- [ ] 用户创建/编辑表单
  - [ ] 基本信息录入（用户名、姓名、邮箱）
  - [ ] 权限设置（角色、上级用户、状态）
  - [ ] 资金设置（初始余额、信用额度、币种）
  - [ ] 密码设置（创建时）
- [ ] 用户详情页面
  - [ ] 完整用户信息展示
  - [ ] 资金操作历史
  - [ ] 关联卡片列表
- [ ] 权限分配界面
- [ ] 用户资金管理
  - [ ] 充值功能（管理员操作）
  - [ ] 提现功能（管理员操作）
  - [ ] 资金记录查询
  - [ ] 资金统计报表

#### 4.2 虚拟卡管理页面
- [ ] 卡片列表页面
  - [ ] 显示卡号、余额、状态等基本信息
  - [ ] 显示开卡人用户名和姓名
  - [ ] 显示创建者信息
  - [ ] 支持按开卡人用户名筛选和搜索
  - [ ] 支持按卡片状态筛选
- [ ] 开卡表单
  - [ ] 录入开卡人用户名（必填）
  - [ ] 录入开卡人姓名（必填）
  - [ ] 选择币种和初始金额
- [ ] 卡片详情页面
- [ ] 充值/提现表单
- [ ] 交易记录查询

#### 4.3 仪表盘和统计
- [ ] 系统概览仪表盘
- [ ] 用户统计图表
- [ ] 卡片使用统计
- [ ] 交易统计分析

### 第五阶段：系统优化和部署（1-2周）

#### 5.1 性能优化
- [ ] 数据库查询优化
- [ ] 缓存策略实现
- [ ] API响应时间优化
- [ ] 前端代码分割和懒加载

#### 5.2 安全加固
- [ ] SQL注入防护
- [ ] XSS防护
- [ ] CSRF防护
- [ ] API限流
- [ ] 敏感数据加密

#### 5.3 部署配置
- [ ] Docker容器化
- [ ] 生产环境配置
- [ ] 监控和日志系统
- [ ] 备份策略

## 开发规范

### 代码规范
- 使用TypeScript进行类型检查
- 遵循ESLint和Prettier配置
- 采用Git Flow分支管理策略
- 提交信息遵循Conventional Commits规范

### API设计规范
- RESTful API设计原则
- 统一的响应格式
- 完整的错误码定义
- 详细的API文档

### 安全规范
- 所有敏感数据必须加密存储
- API接口必须进行权限验证
- 定期更新依赖包版本
- 定期进行安全审计

## 项目里程碑

| 阶段 | 时间 | 关键交付物 |
|------|------|-----------|
| 第一阶段 | 第1-2周 | 后端基础架构、数据库设计 |
| 第二阶段 | 第3-4周 | 用户管理系统 |
| 第三阶段 | 第5-7周 | 卡商API对接 |
| 第四阶段 | 第8-10周 | 前端页面开发 |
| 第五阶段 | 第11-12周 | 系统优化和部署 |

## 风险评估和应对

### 技术风险
- **卡商API稳定性**: 建立完善的错误处理和重试机制
- **数据安全**: 采用多层加密和安全验证
- **系统性能**: 合理设计缓存策略和数据库索引

### 业务风险
- **需求变更**: 采用敏捷开发方法，保持灵活性
- **用户体验**: 持续进行用户测试和反馈收集
- **合规要求**: 确保符合相关法规和行业标准

## 后续维护计划

### 功能扩展
- 多卡商支持
- 移动端应用
- 高级报表功能
- 自动化运维

### 技术升级
- 定期更新依赖包
- 性能监控和优化
- 安全漏洞修复
- 新技术栈评估和迁移

---

*本文档将随着项目进展持续更新和完善*
