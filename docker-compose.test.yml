version: '3.8'

# ç”¨äºæµ‹è¯•å®šæ—¶åŒæ­¥åŠŸèƒ½çš„Docker Composeé…ç½®
# ä½¿ç”¨å‘½ä»¤: docker-compose -f docker-compose.test.yml up backend-test

networks:
  test-network:
    driver: bridge

volumes:
  test_logs:
    driver: local

services:
  # ä»…å¯åŠ¨åç«¯æœåŠ¡è¿›è¡Œå®šæ—¶ä»»åŠ¡æµ‹è¯•
  backend-test:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: vcard-backend-test
    environment:
      NODE_ENV: development
      PORT: 3001
      TZ: Asia/Shanghai
      # æµ‹è¯•ç”¨çš„æ•°æ®åº“è¿æ¥ (å¯ä»¥æ˜¯å¤–éƒ¨æ•°æ®åº“æˆ–mock)
      DATABASE_URL: postgresql://test_user:test_pass@host.docker.internal:5432/test_db
      REDIS_URL: redis://:test_pass@host.docker.internal:6379
      JWT_SECRET: test_jwt_secret_key
      JWT_EXPIRES_IN: 7d
      CARD_PROVIDER_TOKEN: test_token
      CARD_PROVIDER_URL: https://openapi-hk.vccdaddy.com
      LOG_LEVEL: info
      # å®šæ—¶åŒæ­¥ä»»åŠ¡é…ç½® - ä½¿ç”¨æ›´é¢‘ç¹çš„æ—¶é—´è¿›è¡Œæµ‹è¯•
      SYNC_ENABLED: true
      # æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ç”¨äºæµ‹è¯• (ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥æ˜¯æ¯æ—¥)
      SYNC_AUTH_PREVIOUS_CRON: "*/2 * * * *"     # æ¯2åˆ†é’Ÿæ‰§è¡Œ
      SYNC_AUTH_CURRENT_CRON: "1-59/2 * * * *"   # æ¯2åˆ†é’Ÿæ‰§è¡Œï¼Œé”™å¼€1åˆ†é’Ÿ
      SYNC_SETTLE_PREVIOUS_CRON: "*/3 * * * *"   # æ¯3åˆ†é’Ÿæ‰§è¡Œ
      SYNC_SETTLE_CURRENT_CRON: "1-59/3 * * * *" # æ¯3åˆ†é’Ÿæ‰§è¡Œï¼Œé”™å¼€1åˆ†é’Ÿ
    ports:
      - "3001:3001"
    networks:
      - test-network
    restart: "no"
    volumes:
      - test_logs:/app/logs
      # æŒ‚è½½æ—¶åŒºéªŒè¯è„šæœ¬
      - ./docker-timezone-test.js:/app/timezone-test.js:ro
    command: sh -c "echo 'ğŸ” å®¹å™¨æ—¶åŒºéªŒè¯:' && node timezone-test.js && echo 'ğŸš€ å¯åŠ¨åº”ç”¨...' && node dist/index.js"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # æ—¶åŒºæµ‹è¯•å®¹å™¨ - ä»…ç”¨äºéªŒè¯æ—¶åŒºé…ç½®
  timezone-test:
    image: node:20-alpine
    container_name: timezone-test
    environment:
      TZ: Asia/Shanghai
      SYNC_ENABLED: true
    volumes:
      - ./docker-timezone-test.js:/app/test.js:ro
    networks:
      - test-network
    command: sh -c "apk add --no-cache tzdata && node /app/test.js"
    restart: "no"


